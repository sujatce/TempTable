select * 
from [orchestration].[dbo].[new_to_therapy] 

order by [orchestration].[dbo].[new_to_therapy].[LOAD_DATETIME], [orchestration].[dbo].[new_to_therapy].[RECORD_ID]  - I put this in a Input Data tool and connect the output to a record id tool to get NEW_TO_THERAPY_ID starting from 1 and then get the output to go to a left input of join tool

the following query in input data  is the right input of the join tool 
select distinct [dm].[GMPI_ID],
	[dm].[MEMBER_MBI] 
from [BI_Analysis].[dbo].[DIM_MEMBER] as [dm] 
where [dm].[MEMBER_MBI] is not NULL 
	and [dm].[ACTIVE_FLAG] = 1


the joining tool has MBI, MEMBER_MBI  column to join on

THE LEFT input of the join tool is connected to formula tool which as  PATIENT_MISMATCH = 1 FOR gmpi_id as null
and then this input is coonected to union tool 
the J output of the join tool is also connected to the union tool 

the output of the union tool is connected to a sort tool where it is ascending order of the NEW_TO_THERAPY_ID 

THE OUTPUT OF this tool is connected to the next container inside which it is connected to the left  input of the join tool 
and the right input comes from the input data with query
select [mrm].[GMPI_ID] 
from [BI_Analysis].[dbo].[MEMBER_REPORT_MONTH] as [mrm] 
where [mrm].[DATA_ENTITY] = 'WellMed' 
	and [mrm].[REPORT_MONTH] = 
	(
	select Max([rm].[REPORT_MONTH]) 
	from [BI_Analysis].[dbo].[MEMBER_REPORT_MONTH] as [rm] 
	where [rm].[DATA_ENTITY] = 'WellMed'
	) 
	and [mrm].[ACTIVE_FLAG] = 1

they are joined on gmpi_id
and now I have the left input and the right input of the join tool connects to union tool and from the union tool , i connect to select tool where I take out the NEW_TO_THERAPY_ID column , because I dont want that to be written to the table as the table is has already defined 
this column 
I want to make sure it is loading by NEW_TO_THERAPY_ID ascending because in the NEW_TO_THERAPY table the data is loaded based on load_datetime ascedning and record_id ascending 

write all the data to the table which has this definition 

CREATE TABLE [dbo].[TEMP_NEW_TO_THERAPY](
	[NEW_TO_THERAPY_ID] [bigint] IDENTITY(1,1) NOT NULL,   -- auto-increment primary key
    [GMPI_ID] [int] NULL,
    [PATIENT_MISMATCH] [bit] NULL,
	[RPT_MO_KEY] [nvarchar](10) NULL,
	[REPORTDATE] [date] NULL,
	[HCONTRACT] [nvarchar](50) NULL,
	[CDO] [nvarchar](50) NULL,
	[CDO_SUBGROUP] [nvarchar](75) NULL,
	[YEAR_DOS] [int] NULL,
	[MONTH_DOS] [bigint] NULL,
	[BYY] [smallint] NULL,
	[MGMT_TYPE] [nvarchar](25) NULL,
	[PBP] [nvarchar](5) NULL,
	[PCP_NPI] [nvarchar](25) NULL,
	[ENTY_ID] [bigint] NULL,
	[PCP_TIN] [nvarchar](25) NULL,
	[EMP_STATUS] [nvarchar](50) NULL,
	[RISK_TYPE] [nvarchar](50) NULL,
	[MEASURE_YEAR] [bigint] NULL,
	[CONTRACT_PBP] [nvarchar](100) NULL,
	[SUPER_CDO] [nvarchar](75) NULL,
	[SUPER_CDO_SUBGROUP] [nvarchar](75) NULL,
	[MAD_FILLS_2Y] [bigint] NULL,
	[MAD_LATEST_FILL_DATE] [date] NULL,
	[MAD_DAYS_SINCE_LAST_FILL] [bigint] NULL,
	[MAD_NEW_TO_THERAPY] [bigint] NULL,
	[MAD_FILLS_180D] [bigint] NULL,
	[MAD_NTT_RESTART] [bigint] NULL,
	[MAD_LATEST_FILL_DAYS_SUPPLY] [bigint] NULL,
	[MAD_LATEST_FILL_QUANTITY] [bigint] NULL,
	[MAC_FILLS_2Y] [bigint] NULL,
	[MAC_LATEST_FILL_DATE] [date] NULL,
	[MAC_DAYS_SINCE_LAST_FILL] [bigint] NULL,
	[MAC_NEW_TO_THERAPY] [bigint] NULL,
	[MAC_FILLS_180D] [bigint] NULL,
	[MAC_NTT_RESTART] [bigint] NULL,
	[MAC_LATEST_FILL_DAYS_SUPPLY] [bigint] NULL,
	[MAC_LATEST_FILL_QUANTITY] [bigint] NULL,
	[MAH_FILLS_2Y] [bigint] NULL,
	[MAH_LATEST_FILL_DATE] [date] NULL,
	[MAH_DAYS_SINCE_LAST_FILL] [bigint] NULL,
	[MAH_NEW_TO_THERAPY] [bigint] NULL,
	[MAH_FILLS_180D] [bigint] NULL,
	[MAH_NTT_RESTART] [bigint] NULL,
	[MAH_LATEST_FILL_DAYS_SUPPLY] [bigint] NULL,
	[MAH_LATEST_FILL_QUANTITY] [bigint] NULL,
	[MBI] [nvarchar](25) NULL,
	[ENCRYPT] [nvarchar](25) NULL,
	[REPORT_DATE] [date] NULL,
	[OC_FLAG] [bit] NULL,
	[EMR_FLAG] [bit] NULL,
	[HC_OC_COMANAGED_FLAG] [bit] NULL,
	[ENTERPRISE_INDV_ID] [nvarchar](25) NULL,
	[CLAIMS_REFRESH_DATE] [date] NULL,
	[MAC_NTT_GENERIC] [nvarchar](75) NULL,
	[MAD_NTT_GENERIC] [nvarchar](75) NULL,
	[MAH_NTT_GENERIC] [nvarchar](75) NULL,
	[MAC_NTT_MED_NAME] [nvarchar](250) NULL,
	[MAD_NTT_MED_NAME] [nvarchar](250) NULL,
	[MAH_NTT_MED_NAME] [nvarchar](250) NULL,
	[PROCESS_LOG_ID] [int] NULL,
	[LOAD_DATETIME] [nvarchar](50) NOT NULL,
	[RECORD_ID] [bigint] NOT NULL,
	[USER_STORY] [varchar](25) NULL,
	[INSERT_DATE] [datetime] NOT NULL,
	[INSERT_USER] [varchar](75) NOT NULL,
	[UPDATE_DATE] [datetime] NOT NULL,
	[UPDATE_USER] [varchar](75) NOT NULL,
	CONSTRAINT [PK_TEMP_NEW_TO_THERAPY] PRIMARY KEY CLUSTERED 
	(	[NEW_TO_THERAPY_ID] ASC 	)
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[TEMP_NEW_TO_THERAPY] ADD  CONSTRAINT [DF_NEW_TO_THERAPY_DefaultInsertDate]  DEFAULT (getdate()) FOR [INSERT_DATE]
GO

ALTER TABLE [dbo].[TEMP_NEW_TO_THERAPY] ADD  CONSTRAINT [DF_NEW_TO_THERAPY_DefaultInsertUser]  DEFAULT (suser_name()) FOR [INSERT_USER]
GO

ALTER TABLE [dbo].[TEMP_NEW_TO_THERAPY] ADD  CONSTRAINT [DF_NEW_TO_THERAPY_DefaultUpdateDate]  DEFAULT (getdate()) FOR [UPDATE_DATE]
GO

ALTER TABLE [dbo].[TEMP_NEW_TO_THERAPY] ADD  CONSTRAINT [DF_NEW_TO_THERAPY_DefaultUpdateUser]  DEFAULT (suser_name()) FOR [UPDATE_USER]
GO

CREATE TRIGGER [dbo].[TR_NEW_TO_THERAPY_UpdateDateUser] ON [dbo].[TEMP_NEW_TO_THERAPY]
AFTER UPDATE 
AS
BEGIN
	UPDATE P
	SET 
		P.[UPDATE_USER] = SUSER_NAME(),
	    P.[UPDATE_DATE] = GETDATE()
	FROM [dbo].[TEMP_NEW_TO_THERAPY] P
	INNER JOIN inserted I
		ON P.[NEW_TO_THERAPY_ID] = I.[NEW_TO_THERAPY_ID]
END;
GO

ALTER TABLE [dbo].[TEMP_NEW_TO_THERAPY] ENABLE TRIGGER [TR_NEW_TO_THERAPY_UpdateDateUser]
GO

