USE [DEVELOPMENT]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE OR ALTER PROCEDURE [dbo].[Copy_All_NewToTherapy_Loads]
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @LoadDate NVARCHAR(50);
    DECLARE @RowCount INT;
    DECLARE @TotalBatches INT = 0;
    DECLARE @TotalRows INT = 0;

    PRINT 'üöÄ Starting automatic copy for all LOAD_DATETIME values...';

    -- Check for new LOAD_DATETIME values not yet in TEMP_NEW_TO_THERAPY
    IF EXISTS (
        SELECT 1
        FROM [DEVELOPMENT].[dbo].[NEW_TO_THERAPY] ntt
        WHERE NOT EXISTS (
            SELECT 1
            FROM [dbo].[TEMP_NEW_TO_THERAPY] temp
            WHERE temp.LOAD_DATETIME = ntt.LOAD_DATETIME
        )
    )
    BEGIN
        PRINT '‚ö° New batch LOAD_DATETIME values available to load!';
    END
    ELSE
    BEGIN
        PRINT '‚ÑπÔ∏è No new LOAD_DATETIME values found to load.';
    END

    -- Cursor to loop through each distinct LOAD_DATETIME
    DECLARE load_cursor CURSOR FOR
    SELECT DISTINCT CONVERT(NVARCHAR(50), LOAD_DATETIME, 120)
    FROM [DEVELOPMENT].[dbo].[NEW_TO_THERAPY] ntt
    WHERE NOT EXISTS (
        SELECT 1
        FROM [dbo].[TEMP_NEW_TO_THERAPY] temp
        WHERE temp.LOAD_DATETIME = ntt.LOAD_DATETIME
    )
    ORDER BY LOAD_DATETIME;

    OPEN load_cursor;
    FETCH NEXT FROM load_cursor INTO @LoadDate;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        BEGIN TRY
            PRINT 'Processing LOAD_DATETIME = ' + @LoadDate;

            INSERT INTO [dbo].[TEMP_NEW_TO_THERAPY] (
                RPT_MO_KEY,
                REPORTDATE,
                HCONTRACT,
                CDO,
                CDO_SUBGROUP,
                YEAR_DOS,
                MONTH_DOS,
                BYY,
                MGMT_TYPE,
                PBP,
                PCP_NPI,
                ENTY_ID,
                PCP_TIN,
                EMP_STATUS,
                RISK_TYPE,
                MEASURE_YEAR,
                CONTRACT_PBP,
                SUPER_CDO,
                SUPER_CDO_SUBGROUP,
                MAD_FILLS_2Y,
                MAD_LATEST_FILL_DATE,
                MAD_DAYS_SINCE_LAST_FILL,
                MAD_NEW_TO_THERAPY,
                MAD_FILLS_180D,
                MAD_NTT_RESTART,
                MAD_LATEST_FILL_DAYS_SUPPLY,
                MAD_LATEST_FILL_QUANTITY,
                MAC_FILLS_2Y,
                MAC_LATEST_FILL_DATE,
                MAC_DAYS_SINCE_LAST_FILL,
                MAC_NEW_TO_THERAPY,
                MAC_FILLS_180D,
                MAC_NTT_RESTART,
                MAC_LATEST_FILL_DAYS_SUPPLY,
                MAC_LATEST_FILL_QUANTITY,
                MAH_FILLS_2Y,
                MAH_LATEST_FILL_DATE,
                MAH_DAYS_SINCE_LAST_FILL,
                MAH_NEW_TO_THERAPY,
                MAH_FILLS_180D,
                MAH_NTT_RESTART,
                MAH_LATEST_FILL_DAYS_SUPPLY,
                MAH_LATEST_FILL_QUANTITY,
                MBI,
                ENCRYPT,
                REPORT_DATE,
                OC_FLAG,
                EMR_FLAG,
                HC_OC_COMANAGED_FLAG,
                ENTERPRISE_INDV_ID,
                CLAIMS_REFRESH_DATE,
                MAC_NTT_GENERIC,
                MAD_NTT_GENERIC,
                MAH_NTT_GENERIC,
                MAC_NTT_MED_NAME,
                MAD_NTT_MED_NAME,
                MAH_NTT_MED_NAME,
                PROCESS_LOG_ID,
                LOAD_DATETIME,
                RECORD_ID,
                USER_STORY
            )
            SELECT
                RPT_MO_KEY,
                REPORTDATE,
                HCONTRACT,
                CDO,
                CDO_SUBGROUP,
                YEAR_DOS,
                MONTH_DOS,
                BYY,
                MGMT_TYPE,
                PBP,
                PCP_NPI,
                ENTY_ID,
                PCP_TIN,
                EMP_STATUS,
                RISK_TYPE,
                MEASURE_YEAR,
                CONTRACT_PBP,
                SUPER_CDO,
                SUPER_CDO_SUBGROUP,
                MAD_FILLS_2Y,
                MAD_LATEST_FILL_DATE,
                MAD_DAYS_SINCE_LAST_FILL,
                MAD_NEW_TO_THERAPY,
                MAD_FILLS_180D,
                MAD_NTT_RESTART,
                MAD_LATEST_FILL_DAYS_SUPPLY,
                MAD_LATEST_FILL_QUANTITY,
                MAC_FILLS_2Y,
                MAC_LATEST_FILL_DATE,
                MAC_DAYS_SINCE_LAST_FILL,
                MAC_NEW_TO_THERAPY,
                MAC_FILLS_180D,
                MAC_NTT_RESTART,
                MAC_LATEST_FILL_DAYS_SUPPLY,
                MAC_LATEST_FILL_QUANTITY,
                MAH_FILLS_2Y,
                MAH_LATEST_FILL_DATE,
                MAH_DAYS_SINCE_LAST_FILL,
                MAH_NEW_TO_THERAPY,
                MAH_FILLS_180D,
                MAH_NTT_RESTART,
                MAH_LATEST_FILL_DAYS_SUPPLY,
                MAH_LATEST_FILL_QUANTITY,
                MBI,
                ENCRYPT,
                REPORT_DATE,
                OC_FLAG,
                EMR_FLAG,
                HC_OC_COMANAGED_FLAG,
                ENTERPRISE_INDV_ID,
                CLAIMS_REFRESH_DATE,
                MAC_NTT_GENERIC,
                MAD_NTT_GENERIC,
                MAH_NTT_GENERIC,
                MAC_NTT_MED_NAME,
                MAD_NTT_MED_NAME,
                MAH_NTT_MED_NAME,
                PROCESS_LOG_ID,
                LOAD_DATETIME,
                RECORD_ID,
                USER_STORY
            FROM [DEVELOPMENT].[dbo].[NEW_TO_THERAPY]
            WHERE LOAD_DATETIME = @LoadDate
            ORDER BY RECORD_ID;  -- <-- Added to guarantee sequential order per batch

            -- Capture row count
            SET @RowCount = @@ROWCOUNT;
            SET @TotalBatches += 1;
            SET @TotalRows += @RowCount;

            PRINT '‚úÖ LOAD_DATETIME ' + @LoadDate + ' has been loaded successfully. (' + CAST(@RowCount AS NVARCHAR(20)) + ' rows)';

            -- Log success for this batch
            INSERT INTO [dbo].[Copy_Log] (RunDateTime, TotalBatches, TotalRows, Status, LoadDateTime)
            VALUES (GETDATE(), @TotalBatches, @RowCount, 'Success', @LoadDate);

        END TRY
        BEGIN CATCH
            PRINT '‚ùå Error occurred for LOAD_DATETIME = ' + @LoadDate + ' | ' + ERROR_MESSAGE();

            -- Log failure for this batch
            INSERT INTO [dbo].[Copy_Log] (RunDateTime, TotalBatches, TotalRows, Status, LoadDateTime)
            VALUES (GETDATE(), @TotalBatches + 1, 0, 'Failure: ' + ERROR_MESSAGE(), @LoadDate);
        END CATCH;

        FETCH NEXT FROM load_cursor INTO @LoadDate;
    END;

    CLOSE load_cursor;
    DEALLOCATE load_cursor;

    PRINT 'üéØ All LOAD_DATETIME batches processed successfully.';
    PRINT 'üìä Summary: ' + CAST(@TotalBatches AS NVARCHAR(10)) + ' batches processed, ' 
          + CAST(@TotalRows AS NVARCHAR(20)) + ' total rows copied.';

    -- Log overall summary
    INSERT INTO [dbo].[Copy_Log] (RunDateTime, TotalBatches, TotalRows, Status)
    VALUES (GETDATE(), @TotalBatches, @TotalRows, 'Completed');

END;
GO
