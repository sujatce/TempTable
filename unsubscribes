CREATE TABLE dbo.SMS_UNSUBSCRIBED
(
    -- =========================
    -- Primary Key
    -- =========================
    SMS_UNSUBSCRIBED_ID BIGINT IDENTITY(1,1) NOT NULL,

    -- =========================
    -- Business Columns
    -- =========================
    GMPI_ID             INT            NULL,
    PHONE_ID            INT            NOT NULL,
    TEMPLATE_ID         INT            NULL,
    PROGRAM_ID          INT            NOT NULL,

    MEMBER_LAST_NAME    VARCHAR(60)    NULL,
    MEMBER_FIRST_NAME   VARCHAR(50)    NULL,
    MEMBER_PHONE        VARCHAR(15)    NOT NULL,

    STATUS              VARCHAR(75)    NOT NULL,
    SOURCE              VARCHAR(75)    NOT NULL,

    UNSUBSCRIBE_PERFORMED_DATE DATETIME NOT NULL,
    PHONE_CREATED_DATE         DATETIME NOT NULL,
    PHONE_UPDATED_DATE         DATETIME NOT NULL,

    FILE_NAME           VARCHAR(250)   NOT NULL,
    FILE_CREATION_DATE  DATE           NOT NULL,
    USER_STORY          VARCHAR(50)    NOT NULL,

    -- =========================
    -- Audit Columns
    -- =========================
    INSERT_DATE         DATETIME       NOT NULL,
    INSERT_USER         VARCHAR(75)    NOT NULL,
    UPDATE_DATE         DATETIME       NOT NULL,
    UPDATE_USER         VARCHAR(75)    NOT NULL,

    -- =========================
    -- Constraints
    -- =========================
    CONSTRAINT PK_SMS_UNSUBSCRIBED_PrimaryKey
        PRIMARY KEY CLUSTERED (SMS_UNSUBSCRIBED_ID)
);
GO




-- Default INSERT_DATE
ALTER TABLE dbo.SMS_UNSUBSCRIBED
ADD CONSTRAINT DF_SMS_UNSUBSCRIBED_InsertDate
DEFAULT (GETDATE()) FOR INSERT_DATE;
GO

-- Default INSERT_USER
ALTER TABLE dbo.SMS_UNSUBSCRIBED
ADD CONSTRAINT DF_SMS_UNSUBSCRIBED_InsertUser
DEFAULT (SUSER_NAME()) FOR INSERT_USER;
GO

-- Default UPDATE_DATE (on insert)
ALTER TABLE dbo.SMS_UNSUBSCRIBED
ADD CONSTRAINT DF_SMS_UNSUBSCRIBED_UpdateDate
DEFAULT (GETDATE()) FOR UPDATE_DATE;
GO

-- Default UPDATE_USER (on insert)
ALTER TABLE dbo.SMS_UNSUBSCRIBED
ADD CONSTRAINT DF_SMS_UNSUBSCRIBED_UpdateUser
DEFAULT (SUSER_NAME()) FOR UPDATE_USER;
GO




CREATE TRIGGER TR_SMS_UNSUBSCRIBED_UpdateDateUser
ON dbo.SMS_UNSUBSCRIBED
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE t
    SET
        UPDATE_DATE = GETDATE(),
        UPDATE_USER = SUSER_NAME()
    FROM dbo.SMS_UNSUBSCRIBED t
    INNER JOIN inserted i
        ON t.SMS_UNSUBSCRIBED_ID = i.SMS_UNSUBSCRIBED_ID;
END;
GO
